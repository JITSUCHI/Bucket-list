<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Columns - My Portal</title>
  <link rel="stylesheet" href="./style.css?v=24" />
  <style>
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
    .btn{border:1px solid #222;background:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .btn:hover{filter:brightness(.97)}
    .input, textarea{border:1px solid #cbd5e1;border-radius:8px;padding:8px}
    .input{min-width:220px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    .card{border:2px solid #222;border-radius:10px;padding:12px}
    .muted{color:#666;font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #94a3b8;border-radius:999px;font-size:12px;color:#334155;margin-right:6px}
    .list-item{padding:8px 0;border-bottom:1px dashed #e5e7eb}
    .list-item:last-child{border-bottom:none}
    .title-link{color:#111;text-decoration:none;font-weight:700}
    .title-link:hover{text-decoration:underline}
    .right{display:flex;gap:6px;align-items:center}
    .preview{border:1px dashed #cbd5e1;border-radius:8px;padding:12px;background:#fafafa;min-height:120px}
    .badge{font-size:12px;border:1px solid #111;border-radius:999px;padding:1px 8px}
    .badge.green{background:#eaffea}
    .badge.gray{background:#f3f4f6}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="paper">
    <div class="sheet">
      <header class="sheet__header">
        <h1>ğŸ“˜ Columnsï¼ˆã‚³ãƒ©ãƒ ï¼‰</h1>
        <p class="muted">ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® <strong>localStorage</strong> ã«ä¿å­˜ã—ã¾ã™ï¼ˆç«¯æœ«ã”ã¨ã«åˆ¥ï¼‰ã€‚</p>
        <nav class="row">
          <a href="index.html" class="btn">â† Bucket List ã«æˆ»ã‚‹</a>
          <button id="exportBtn" class="btn" type="button">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label class="btn" style="position:relative;overflow:hidden">
            JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            <input id="importInput" type="file" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer">
          </label>
          <button id="resetBtn" class="btn" type="button">åˆæœŸåŒ–</button>
        </nav>
      </header>

      <!-- ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card" aria-labelledby="composer">
        <h2 id="composer" style="margin:0 0 8px">âœï¸ æ–°è¦ã‚³ãƒ©ãƒ </h2>
        <div class="grid grid-2">
          <div class="grid">
            <input id="title" class="input" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
            <input id="tags" class="input" type="text" placeholder="ã‚¿ã‚°ï¼ˆä¾‹: python,å…¥é–€ï¼‰ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š">
            <select id="level" class="input">
              <option value="Beginner">Beginnerï¼ˆå…¥é–€ï¼‰</option>
              <option value="Intermediate">Intermediateï¼ˆä¸­ç´šï¼‰</option>
              <option value="Advanced">Advancedï¼ˆä¸Šç´šï¼‰</option>
            </select>
            <div class="row">
              <label><input id="published" type="checkbox"> å…¬é–‹</label>
              <span class="muted">å…¬é–‹ã«ã™ã‚‹ã¨ä¸€è¦§ã«ã€Œå…¬é–‹ã€ãƒãƒƒã‚¸ãŒã¤ãã¾ã™</span>
            </div>
          </div>
          <div class="grid">
            <textarea id="content" rows="10" placeholder="æœ¬æ–‡ï¼ˆç°¡æ˜“Markdown: # è¦‹å‡ºã—, **å¼·èª¿**, - ç®‡æ¡æ›¸ã, ```ã‚³ãƒ¼ãƒ‰``` ãªã©ï¼‰"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="saveBtn" class="btn" type="button">ä¿å­˜</button>
          <button id="clearBtn" class="btn" type="button">ã‚¯ãƒªã‚¢</button>
          <span class="muted" id="statusText"></span>
        </div>
        <div style="margin-top:12px">
          <h3 style="margin:0 0 6px">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div id="preview" class="preview"></div>
        </div>
      </section>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
      <section class="toolbar">
        <input id="q" class="input" type="search" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/æœ¬æ–‡/ã‚¿ã‚°ï¼‰">
        <select id="filterLevel" class="input">
          <option value="all">ã™ã¹ã¦ã®é›£æ˜“åº¦</option>
          <option>Beginner</option>
          <option>Intermediate</option>
          <option>Advanced</option>
        </select>
        <select id="filterPub" class="input">
          <option value="all">å…¬é–‹/ä¸‹æ›¸ãã™ã¹ã¦</option>
          <option value="published">å…¬é–‹ã®ã¿</option>
          <option value="draft">ä¸‹æ›¸ãã®ã¿</option>
        </select>
      </section>

      <!-- ä¸€è¦§ -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">ğŸ“š ã‚³ãƒ©ãƒ ä¸€è¦§</h2>
          <span class="muted" id="updated">ï¼ˆæœ€çµ‚æ›´æ–°æ—¥: â€”ï¼‰</span>
        </div>
        <div id="list"></div>
      </section>
    </div>
  </div>

  <script>
  // === è¨­å®š ===
  const KEY = "columns_v1";

  // ç°¡æ˜“Markdown â†’ HTMLï¼ˆæœ€ä½é™ï¼‰
  function md(s=""){
    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    s = s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
    s = s.replace(/```([\s\S]*?)```/g, (_,code)=>`<pre><code>${code}</code></pre>`);
    // è¦‹å‡ºã—
    s = s.replace(/^###\s+(.*)$/gm, "<h3>$1</h3>")
         .replace(/^##\s+(.*)$/gm, "<h2>$1</h2>")
         .replace(/^#\s+(.*)$/gm, "<h1>$1</h1>");
    // å¼·èª¿
    s = s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
         .replace(/\*(.+?)\*/g, "<em>$1</em>");
    // ç®‡æ¡æ›¸ã
    s = s.replace(/^(?:-|\*)\s+(.*)$/gm, "<li>$1</li>");
    s = s.replace(/(<li>[\s\S]*?<\/li>)(?!\s*<li>)/g, "<ul>$1</ul>");
    // æ”¹è¡Œ
    s = s.replace(/\n{2,}/g, "</p><p>").replace(/\n/g, "<br>");
    return `<p>${s}</p>`;
  }

  // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
  const load = () => JSON.parse(localStorage.getItem(KEY) || "null") || {updatedAt:null, items:[]};
  const save = (data) => {
    data.updatedAt = new Date().toISOString();
    localStorage.setItem(KEY, JSON.stringify(data));
    document.getElementById("updated").textContent = `ï¼ˆæœ€çµ‚æ›´æ–°æ—¥: ${new Date(data.updatedAt).toLocaleString()}ï¼‰`;
  };
  let state = load();

  // DOM util
  const el = (t,a={},...cs)=>{ const n=document.createElement(t); for(const[k,v] of Object.entries(a)){
    if(k==="class") n.className=v; else if(k.startsWith("on")) n.addEventListener(k.slice(2),v); else n.setAttribute(k,v);
  } cs.forEach(c=>n.append(c instanceof Node?c:document.createTextNode(c))); return n; };

  // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ 
  const $ = s => document.querySelector(s);
  const titleEl = $("#title"), tagsEl=$("#tags"), levelEl=$("#level"),
        publishedEl=$("#published"), contentEl=$("#content"),
        statusText=$("#statusText"), previewEl=$("#preview");

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  function updatePreview(){ previewEl.innerHTML = md(contentEl.value||""); }
  contentEl.addEventListener("input", updatePreview);
  updatePreview();

  // ä¿å­˜
  $("#saveBtn").addEventListener("click", ()=>{
    const id = "c_" + Date.now();
    const item = {
      id,
      title: (titleEl.value||"").trim(),
      tags: (tagsEl.value||"").split(",").map(s=>s.trim()).filter(Boolean),
      level: levelEl.value,
      published: !!publishedEl.checked,
      content: contentEl.value||"",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };
    if(!item.title){ alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    state.items.unshift(item);
    save(state);
    clearForm();
    render();
    statusText.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
    setTimeout(()=>statusText.textContent="", 1500);
  });

  function clearForm(){
    titleEl.value = ""; tagsEl.value = ""; levelEl.value="Beginner";
    publishedEl.checked = false; contentEl.value = ""; updatePreview();
  }
  $("#clearBtn").addEventListener("click", clearForm);

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/åˆæœŸåŒ–
  $("#exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = "columns.json"; a.click();
    URL.revokeObjectURL(a.href);
  });
  $("#importInput").addEventListener("change", async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      if(!Array.isArray(data.items)) throw new Error("invalid");
      state = data; save(state); render();
    }catch(err){ alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
    e.target.value = "";
  });
  $("#resetBtn").addEventListener("click", ()=>{
    if(confirm("ã™ã¹ã¦ã®ã‚³ãƒ©ãƒ ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")){
      state = {updatedAt:null, items:[]}; save(state); render();
    }
  });

  // ä¸€è¦§ãƒ»æ¤œç´¢
  $("#q").addEventListener("input", render);
  $("#filterLevel").addEventListener("change", render);
  $("#filterPub").addEventListener("change", render);

  function render(){
    const box = $("#list"); box.innerHTML = "";
    if(state.updatedAt){
      $("#updated").textContent = `ï¼ˆæœ€çµ‚æ›´æ–°æ—¥: ${new Date(state.updatedAt).toLocaleString()}ï¼‰`;
    }

    const q = ($("#q").value||"").toLowerCase();
    const lv = $("#filterLevel").value;
    const pub = $("#filterPub").value;

    let items = [...(state.items||[])];
    items = items.filter(it=>{
      if(lv!=="all" && it.level !== lv) return false;
      if(pub==="published" && !it.published) return false;
      if(pub==="draft" && it.published) return false;
      if(q){
        const hay = [it.title, it.content, (it.tags||[]).join(",")].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    if(items.length===0){
      box.append(el("p",{class:"muted"},"ã¾ã ã‚³ãƒ©ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚"));
      return;
    }

    items.forEach(it=>{
      const row = el("div",{class:"list-item"});
      const head = el("div",{class:"row", style:"justify-content:space-between"});
      const left = el("div",{},
        el("a",{href:"#", class:"title-link", onclick:(e)=>{e.preventDefault(); openArticle(it.id);}}, it.title),
        " ",
        el("span",{class:"badge "+(it.published?"green":"gray")}, it.published?"å…¬é–‹":"ä¸‹æ›¸ã"),
        " ",
        el("span",{class:"muted"}, new Date(it.updatedAt).toLocaleString())
      );
      const right = el("div",{class:"right"},
        el("span",{}, it.level),
        ...(it.tags||[]).map(t=>el("span",{class:"pill"}, t)),
        el("button",{class:"btn", onclick:()=>openEditor(it.id)}, "ç·¨é›†"),
        el("button",{class:"btn", onclick:()=>togglePub(it.id)}, it.published?"éå…¬é–‹ã«":"å…¬é–‹ã«"),
        el("button",{class:"btn", onclick:()=>remove(it.id)}, "å‰Šé™¤"),
      );
      head.append(left, right);
      row.append(head);
      box.append(row);
    });
  }

  function openArticle(id){
    const it = state.items.find(x=>x.id===id);
    if(!it) return;
    const box = $("#list"); box.innerHTML="";
    box.append(
      el("div",{class:"card"},
        el("h2",{}, it.title),
        el("div",{}, el("span",{class:"pill"}, it.level), " ", ...(it.tags||[]).map(t=>el("span",{class:"pill"}, t))),
        el("div",{class:"muted", style:"margin:6px 0"}, it.published?"å…¬é–‹":"ä¸‹æ›¸ã", " / æ›´æ–°: ", new Date(it.updatedAt).toLocaleString()),
        el("hr"),
        el("div",{class:"preview", style:"background:#fff"}, el("div",{innerHTML: md(it.content)})),
        el("div",{class:"row", style:"margin-top:12px"},
          el("button",{class:"btn", onclick:()=>openEditor(id)},"ç·¨é›†"),
          el("button",{class:"btn", onclick:()=>render()},"ä¸€è¦§ã«æˆ»ã‚‹")
        )
      )
    );
  }

  function openEditor(id){
    const it = state.items.find(x=>x.id===id);
    if(!it) return;
    // ãƒ•ã‚©ãƒ¼ãƒ ã«æµã—è¾¼ã‚€
    titleEl.value = it.title;
    tagsEl.value = (it.tags||[]).join(",");
    levelEl.value = it.level;
    publishedEl.checked = !!it.published;
    contentEl.value = it.content;
    updatePreview();
    statusText.textContent = "ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šä¿å­˜ã§ä¸Šæ›¸ãã—ã¾ã™";

    // ä¿å­˜ãƒœã‚¿ãƒ³ã®æŒ™å‹•ã‚’ä¸€æ™‚å·®ã—æ›¿ãˆ
    const saveBtn = document.getElementById("saveBtn");
    const orig = saveBtn.onclick;
    saveBtn.onclick = ()=>{
      it.title = (titleEl.value||"").trim();
      it.tags = (tagsEl.value||"").split(",").map(s=>s.trim()).filter(Boolean);
      it.level = levelEl.value;
      it.published = !!publishedEl.checked;
      it.content = contentEl.value||"";
      it.updatedAt = new Date().toISOString();
      save(state);
      clearForm();
      render();
      statusText.textContent = "æ›´æ–°ã—ã¾ã—ãŸ";
      setTimeout(()=>statusText.textContent="", 1500);
      saveBtn.onclick = orig; // å…ƒã«æˆ»ã™
    };
  }

  function togglePub(id){
    const it = state.items.find(x=>x.id===id); if(!it) return;
    it.published = !it.published;
    it.updatedAt = new Date().toISOString();
    save(state); render();
  }

  function remove(id){
    if(!confirm("ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    state.items = state.items.filter(x=>x.id!==id);
    save(state); render();
  }

  // åˆæœŸè¡¨ç¤º
  render();
  </script>
</body>
</html>
