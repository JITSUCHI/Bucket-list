<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Bucket List（編集可・自動連番・追加対応）</title>
  <link rel="stylesheet" href="./style.css?v=22" />
  <style>
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0 16px}
    .btn{border:1px solid #222;background:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .btn:hover{filter:brightness(0.98)}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0 6px}
    .row input[type="text"]{flex:1;min-width:160px;padding:8px;border:1px solid #cbd5e1;border-radius:6px}
    .row select{padding:7px;border:1px solid #cbd5e1;border-radius:6px}
    .item-actions{display:inline-flex;gap:6px;margin-left:8px;opacity:.7}
    .item-actions button{border:1px solid #cbd5e1;background:#fff;border-radius:6px;padding:2px 6px;cursor:pointer}
    .item-actions button:hover{background:#f1f5f9}
    .editable[contenteditable="true"]{outline:2px dashed #60a5fa; outline-offset:2px; background:#eff6ff}
    .muted{color:#666; font-size:12px}
  </style>
</head>
<body>
  <div class="paper">
    <div class="sheet">
      <header class="sheet__header">
        <h1>My Bucket List</h1>
        <p class="legend">
          <span class="legend__red">赤色:達成</span>、
          <span class="legend__blue">青色:進捗あり</span>、
          <span class="legend__green">緑色:継続中</span>
        </p>
        <p class="updated" id="updated">（最終更新日: —）</p>
      </header>

      <div id="app"></div>

      <p class="muted">※ この版は localStorage に保存します。別端末では JSONエクスポート／インポートを使ってください。</p>
    </div>
  </div>

  <script>
  // ====== データ ======
  const KEY = "bucketlist_v3";
  const initialData = {
    updatedAt: new Date().toISOString(),
    categories: [
      { id:"travel", title:"🗺 旅行・冒険", items:[
        { text:"南極に行く", status:"todo" },
        { text:"小笠原で星空キャンプ", status:"todo" },
      ]},
      { id:"learn", title:"📚 学習・スキル", items:[
        { text:"G検定に合格する", status:"todo" },
        { text:"E資格に合格する", status:"todo" },
      ]},
    ]
  };

  const statusClass = {
    done:"done red", progress:"blue", ongoing:"green", todo:""
  };

  const load = ()=>JSON.parse(localStorage.getItem(KEY)||"null")||structuredClone(initialData);
  const save = (d)=>{d.updatedAt=new Date().toISOString();localStorage.setItem(KEY,JSON.stringify(d));
    document.getElementById("updated").textContent=`（最終更新日: ${new Date(d.updatedAt).toLocaleString()}）`;
  };

  let state = load();

  const el=(tag,attrs={},...chs)=>{
    const n=document.createElement(tag);
    for(const[k,v] of Object.entries(attrs)){
      if(k==="class") n.className=v;
      else if(k.startsWith("on")) n.addEventListener(k.slice(2),v);
      else n.setAttribute(k,v);
    }
    chs.forEach(c=>n.append(c instanceof Node?c:document.createTextNode(c)));
    return n;
  };

  // ====== Render ======
  function render(){
    const app=document.getElementById("app"); app.innerHTML="";
    let counter=1;

    state.categories.forEach(cat=>{
      const details=el("details",{class:"blk",open:true});
      details.append(el("summary",{},el("span",{},cat.title)));

      // 追加UI
      const addRow = el("div",{class:"row"},
        el("input",{type:"text",placeholder:"項目を追加…",id:`add-${cat.id}`}),
        el("select",{id:`sel-${cat.id}`},
          el("option",{value:"todo"},"未"),
          el("option",{value:"progress"},"進捗"),
          el("option",{value:"ongoing"},"継続"),
          el("option",{value:"done"},"達成"),
        ),
        el("button",{class:"btn",onclick:()=>addItem(cat.id)},"追加")
      );
      details.append(addRow);

      const ol=el("ol",{class:"items"});
      cat.items.forEach((item,idx)=>{
        ol.append(renderItem(cat.id,idx,item,counter));
        counter++;
      });
      details.append(ol);
      app.append(details);
    });
    save(state);
  }

  function renderItem(catId, idx, item, no){
    const li=el("li");
    const span=el("span",{class:`editable ${statusClass[item.status]||""}`,contenteditable:"false"});
    span.textContent=`${no}. ${item.text}`;

    const sel=el("select",{onchange:e=>{
      item.status=e.target.value;
      span.className=`editable ${statusClass[item.status]||""}`;
      save(state); render();
    }},
      el("option",{value:"todo",selected:item.status==="todo"},"未"),
      el("option",{value:"progress",selected:item.status==="progress"},"進捗"),
      el("option",{value:"ongoing",selected:item.status==="ongoing"},"継続"),
      el("option",{value:"done",selected:item.status==="done"},"達成"),
    );

    const actions=el("span",{class:"item-actions"},
      el("button",{onclick:()=>{
        const ed=span.getAttribute("contenteditable")==="true";
        if(ed){span.setAttribute("contenteditable","false"); item.text=span.textContent.replace(/^\d+\.\s*/,"").trim(); save(state);}
        else{span.setAttribute("contenteditable","true");span.focus();}
      }},"✎"),
      el("button",{onclick:()=>moveItem(catId,idx,-1)},"↑"),
      el("button",{onclick:()=>moveItem(catId,idx,1)},"↓"),
      el("button",{onclick:()=>deleteItem(catId,idx)},"🗑"),
    );

    li.append(span," ",sel,actions);
    return li;
  }

  // ====== 操作 ======
  function addItem(catId){
    const input=document.getElementById(`add-${catId}`);
    const sel=document.getElementById(`sel-${catId}`);
    const text=(input.value||"").trim();
    if(!text) return;
    const cat=state.categories.find(c=>c.id===catId);
    cat.items.push({text,status:sel.value});
    input.value="";
    render();
  }

  function deleteItem(catId,idx){
    const cat=state.categories.find(c=>c.id===catId);
    cat.items.splice(idx,1); render();
  }
  function moveItem(catId,idx,d){
    const cat=state.categories.find(c=>c.id===catId);
    const j=idx+d; if(j<0||j>=cat.items.length)return;
    const [it]=cat.items.splice(idx,1); cat.items.splice(j,0,it); render();
  }

  render();
  </script>
</body>
</html>
