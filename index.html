<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Bucket Listï¼ˆç·¨é›†å¯ï¼‰</title>
  <link rel="stylesheet" href="./style.css?v=20" />
  <style>
    /* æ—¢å­˜ã®ä¾¿ç®‹CSSã«è¶³ã™è»½ã„UIç”¨ */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0 16px}
    .btn{border:1px solid #222;background:#fff;border-radius:6px;padding:6px 10px;cursor:pointer}
    .btn:hover{filter:brightness(0.98)}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0 6px}
    .row input[type="text"]{flex:1;min-width:160px;padding:8px;border:1px solid #cbd5e1;border-radius:6px}
    .row select{padding:7px;border:1px solid #cbd5e1;border-radius:6px}
    .item-actions{display:inline-flex;gap:6px;margin-left:8px;opacity:.7}
    .item-actions button{border:1px solid #cbd5e1;background:#fff;border-radius:6px;padding:2px 6px;cursor:pointer}
    .item-actions button:hover{background:#f1f5f9}
    .editable[contenteditable="true"]{outline:2px dashed #60a5fa; outline-offset:2px; background:#eff6ff}
    .muted{color:#666; font-size:12px}
  </style>
</head>
<body>
  <div class="paper">
    <div class="sheet">
      <header class="sheet__header">
        <h1>My Bucket List</h1>
        <p class="legend">
          <span class="legend__red">èµ¤è‰²:é”æˆï¼ˆå–ã‚Šæ¶ˆã—ç·šï¼‰</span>ã€
          <span class="legend__blue">é’è‰²:é€²æ—ã‚ã‚Š</span>ã€
          <span class="legend__green">ç·‘è‰²:ç¶™ç¶šä¸­</span>
        </p>
        <p class="updated" id="updated">ï¼ˆæœ€çµ‚æ›´æ–°æ—¥: â€”ï¼‰</p>
        <div class="toolbar">
          <button class="btn" id="exportBtn">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label class="btn" style="position:relative;overflow:hidden">
            JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            <input id="importInput" type="file" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer">
          </label>
          <button class="btn" id="resetBtn" title="åˆæœŸãƒ‡ãƒ¼ã‚¿ã«æˆ»ã™">åˆæœŸåŒ–</button>
        </div>
      </header>

      <!-- ã‚«ãƒ†ã‚´ãƒªã¯JSã§æç”»ã€‚ä¸‹ã® noscript ã¯å¿µã®ãŸã‚ã®ä»£æ›¿è¡¨ç¤º -->
      <noscript>
        <details class="blk" open><summary>ã“ã®ãƒšãƒ¼ã‚¸ã¯JavaScriptãŒå¿…è¦ã§ã™</summary>
          <ol class="items"><li>ãƒ–ãƒ©ã‚¦ã‚¶ã§JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</li></ol>
        </details>
      </noscript>

      <div id="app"></div>

      <p class="muted">â€» ã“ã®ç‰ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® <strong>localStorage</strong> ã«ä¿å­˜ã—ã¾ã™ï¼ˆç«¯æœ«ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«åˆ¥ï¼‰ã€‚å…±æœ‰ã—ãŸã„å ´åˆã¯ä¸‹ã®ã€Œå°†æ¥ã®æ‹¡å¼µã€ã‚’å‚ç…§ã€‚</p>
    </div>
  </div>

  <script>
  // ====== ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« ======
  const KEY = "bucketlist_v1";
  const initialData = {
    updatedAt: new Date().toISOString(),
    categories: [
      { id:"travel",  title:"ğŸ—º æ—…è¡Œãƒ»å†’é™º", items:[
        { text:"å—æ¥µã«è¡Œã", status:"todo" },
        { text:"å°ç¬ åŸã§æ˜Ÿç©ºã‚­ãƒ£ãƒ³ãƒ—", status:"todo" },
        { text:"éŸ“å›½ã§ãƒãƒ¼ã‚«ãƒ¼ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã«å‚åŠ ã™ã‚‹", status:"todo" },
        { text:"â—‹â—‹ã«ç™»å±±ã™ã‚‹", status:"todo" },
      ]},
      { id:"learn",   title:"ğŸ“š å­¦ç¿’ãƒ»ã‚¹ã‚­ãƒ«", items:[
        { text:"Gæ¤œå®šã«åˆæ ¼ã™ã‚‹", status:"todo" },
        { text:"Eè³‡æ ¼ã«åˆæ ¼ã™ã‚‹", status:"todo" },
        { text:"AWSè³‡æ ¼ã‚’å–å¾—ã™ã‚‹", status:"todo" },
        { text:"Webã‚¢ãƒ—ãƒªã‚’å…¬é–‹ã™ã‚‹", status:"todo" },
      ]},
      { id:"career",  title:"ğŸ’¼ ã‚­ãƒ£ãƒªã‚¢ãƒ»ãŠé‡‘", items:[
        { text:"å€‹äººé–‹ç™ºã§æœˆâ—¯ä¸‡å††ã®åç›Šã‚’å¾—ã‚‹", status:"todo" },
        { text:"æŠ•è³‡ã§è³‡ç”£â—¯â—¯ä¸‡å††ã‚’ç¯‰ã", status:"todo" },
      ]},
      { id:"life",    title:"ğŸƒ å¥åº·ãƒ»ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«", items:[
        { text:"ä½“é‡60kgã‚’é”æˆã™ã‚‹", status:"todo" },
        { text:"é€±2å›ã‚¸ãƒ ã«é€šã†", status:"todo" },
        { text:"ã‚­ãƒ£ãƒ³ãƒ—é£¯ã‚’è‡ªåˆ†ã§ä½œã‚‹", status:"todo" },
      ]},
      { id:"hobby",   title:"ğŸ¨ è¶£å‘³ãƒ»ä½“é¨“", items:[
        { text:"Columbiaã®ã‚­ãƒ£ãƒ³ãƒ—ã‚¦ã‚§ã‚¢ã‚’æƒãˆã‚‹", status:"todo" },
        { text:"æ˜Ÿç©ºã®ä¸‹ã§ç„šãç«ã‚’ã™ã‚‹", status:"todo" },
        { text:"ãƒ€ãƒ³ãƒ€ãƒ€ãƒ³ã‚’å…¨å·»èª­ã‚€", status:"todo" },
      ]},
      { id:"mind",    title:"ğŸŒ± ç²¾ç¥ãƒ»æ•™é¤Š", items:[
        { text:"ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½ã‚’ä½“ç³»çš„ã«å­¦ã¶", status:"todo" },
        { text:"ä¸€å†Šã«æ²¡é ­ã™ã‚‹èª­æ›¸æ™‚é–“ã‚’ä½œã‚‹", status:"todo" },
        { text:"â—‹â—‹ã®æ˜ ç”»ã‚’è¦³ã‚‹", status:"todo" },
      ]},
      { id:"log",     title:"ğŸ“… é€²æ—ãƒ¡ãƒ¢", items:[
        { text:"2025-08-31ï¼šã‚µã‚¤ãƒˆåˆç‰ˆã‚’å…¬é–‹", status:"progress" }
      ]},
    ]
  };

  // çŠ¶æ…‹â†’ã‚¯ãƒ©ã‚¹
  const statusClass = {
    done:   "done red",
    progress: "blue",
    ongoing:  "green",
    todo:   ""
  };

  // ====== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ======
  const load = () => {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return structuredClone(initialData);
      const parsed = JSON.parse(raw);
      // å¤ã„æ§‹é€ ã¨ã®äº’æ›
      if (!parsed.categories) parsed.categories = structuredClone(initialData.categories);
      return parsed;
    } catch(e) {
      console.warn("load failed", e);
      return structuredClone(initialData);
    }
  };
  const save = (data) => {
    data.updatedAt = new Date().toISOString();
    localStorage.setItem(KEY, JSON.stringify(data));
    document.getElementById("updated").textContent =
      `ï¼ˆæœ€çµ‚æ›´æ–°æ—¥: ${new Date(data.updatedAt).toLocaleString()}ï¼‰`;
  };

  let state = load();

  // ====== æç”» ======
  const el = (tag, attrs={}, ...children) => {
    const node = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k === "class") node.className = v;
      else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
      else if (v !== null && v !== undefined) node.setAttribute(k, v);
    });
    children.forEach(c => node.append(c instanceof Node ? c : document.createTextNode(c)));
    return node;
  };

  function render(){
    const app = document.getElementById("app");
    app.innerHTML = "";
    state.categories.forEach(cat=>{
      const details = el("details", {class:"blk", open:true});
      const summary = el("summary", {}, el("span", {}, cat.title));
      details.append(summary);

      // è¿½åŠ è¡Œ
      const addRow = el("div", {class:"row"},
        el("input", {type:"text", placeholder:"é …ç›®ã‚’è¿½åŠ â€¦", id:`add-${cat.id}`}),
        el("select", {id:`sel-${cat.id}`},
          el("option", {value:"todo"}, "æœª"),
          el("option", {value:"progress"}, "é€²æ—"),
          el("option", {value:"ongoing"}, "ç¶™ç¶š"),
          el("option", {value:"done"}, "é”æˆ"),
        ),
        el("button", {class:"btn", onclick:()=>addItem(cat.id)}, "è¿½åŠ ")
      );
      details.append(addRow);

      // ãƒªã‚¹ãƒˆæœ¬ä½“
      const ol = el("ol", {class:"items", id:`ol-${cat.id}`});
      cat.items.forEach((item, idx)=>{
        ol.append(renderItem(cat.id, idx, item));
      });
      details.append(ol);
      app.append(details);
    });
    // æ›´æ–°æ—¥
    document.getElementById("updated").textContent =
      `ï¼ˆæœ€çµ‚æ›´æ–°æ—¥: ${new Date(state.updatedAt).toLocaleString()}ï¼‰`;
  }

  function renderItem(catId, idx, item){
    const li = el("li");
    const span = el("span", {class:`editable ${statusClass[item.status]||""}`, contenteditable:"false"});
    span.textContent = item.text;

    // çŠ¶æ…‹ã‚»ãƒ¬ã‚¯ãƒˆ
    const sel = el("select", {title:"çŠ¶æ…‹", onchange:(e)=>{
      item.status = e.target.value;
      span.className = `editable ${statusClass[item.status]||""}`;
      save(state);
    }},
      el("option", {value:"todo",    selected:item.status==="todo"}, "æœª"),
      el("option", {value:"progress",selected:item.status==="progress"}, "é€²æ—"),
      el("option", {value:"ongoing", selected:item.status==="ongoing"}, "ç¶™ç¶š"),
      el("option", {value:"done",    selected:item.status==="done"}, "é”æˆ"),
    );

    // ãƒœã‚¿ãƒ³ç¾¤
    const actions = el("span", {class:"item-actions"},
      el("button", {title:"ç·¨é›†/ç¢ºå®š", onclick:()=>{
        const editing = span.getAttribute("contenteditable")==="true";
        if (editing){
          span.setAttribute("contenteditable","false");
          item.text = span.textContent.trim();
          save(state);
        }else{
          span.setAttribute("contenteditable","true");
          span.focus();
          // ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã‚’æœ«å°¾ã¸
          document.getSelection().selectAllChildren(span);
          document.getSelection().collapseToEnd();
        }
      }}, "âœ"),
      el("button", {title:"ä¸Šã¸", onclick:()=>moveItem(catId, idx, -1)}, "â†‘"),
      el("button", {title:"ä¸‹ã¸", onclick:()=>moveItem(catId, idx, +1)}, "â†“"),
      el("button", {title:"å‰Šé™¤", onclick:()=>deleteItem(catId, idx)}, "ğŸ—‘")
    );

    li.append(span, " ", sel, actions);
    return li;
  }

  // ====== CRUD ======
  function addItem(catId){
    const input = document.getElementById(`add-${catId}`);
    const sel   = document.getElementById(`sel-${catId}`);
    const text = (input.value||"").trim();
    if (!text) return;
    const cat = state.categories.find(c=>c.id===catId);
    cat.items.push({text, status: sel.value});
    input.value = "";
    save(state);
    render();
  }

  function deleteItem(catId, idx){
    const cat = state.categories.find(c=>c.id===catId);
    cat.items.splice(idx,1);
    save(state);
    render();
  }

  function moveItem(catId, idx, delta){
    const cat = state.categories.find(c=>c.id===catId);
    const j = idx + delta;
    if (j<0 || j>=cat.items.length) return;
    const [it] = cat.items.splice(idx,1);
    cat.items.splice(j,0,it);
    save(state);
    render();
  }

  // ====== Export / Import / Reset ======
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bucketlist.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      if (!data.categories) throw new Error("Invalid JSON");
      state = data;
      save(state);
      render();
    }catch(err){
      alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
      console.error(err);
    }finally{
      e.target.value = "";
    }
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if (confirm("åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")){
      state = structuredClone(initialData);
      save(state);
      render();
    }
  });

  // åˆæœŸæç”»
  render();
  </script>
</body>
</html>
