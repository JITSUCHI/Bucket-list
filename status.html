<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>状況別ビュー</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;background:#f4f6f8;color:#333}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #ddd;padding:12px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:none;background:#e9ecf2;color:#333;padding:6px 12px;border-radius:6px;cursor:pointer;border:1px solid #ccc;font-size:14px}
    main{padding:16px;max-width:860px;margin:0 auto}
    .controls{background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    select{font-size:14px;padding:6px 10px}
    .grid{display:flex;flex-direction:column;gap:20px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px}
    .card h2{font-size:15px;color:#555;margin:0 0 12px}
    .list{display:flex;flex-direction:column;gap:6px}
    .item{display:flex;gap:8px;align-items:center;background:#fafafa;border:1px solid #ddd;border-radius:8px;padding:6px}
    .title{flex:1}
    .item[data-status="継続"] .title{color:#2e7d32;font-weight:600}
    .item[data-status="達成"] .title{text-decoration:line-through;color:#777}
    .muted{color:#666;font-size:13px}
    .who{margin-left:auto;color:#666;font-size:12px}
    @media (max-width: 600px){
      html, body { font-size: 16px; }
      .btn, button, select, input[type="text"], textarea { min-height: 44px; font-size: 16px; }
      .toolbar, .controls { flex-direction: column; align-items: stretch; }
      .item { flex-direction: column; align-items: stretch; }
      .item .title { white-space: normal; }
      .item button, .item select { width: 100%; }
    }
  </style>

  <!-- Firebase（index/detailと同じ） -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBMURao1Asl1NyFzgWmRoIWKNKep6Wlz8s",
      authDomain: "bucketlist-4fd82.firebaseapp.com",
      projectId: "bucketlist-4fd82",
      storageBucket: "bucketlist-4fd82.firebasestorage.app",
      messagingSenderId: "843717902501",
      appId: "1:843717902501:web:8499a2c78e414716038d4c",
      measurementId: "G-PGQPCCND2D"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    window.__fb = {
      app, auth, db,
      GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      signOut, onAuthStateChanged, doc, getDoc, setDoc
    };
  </script>
</head>
<body>
  <header>
    <h1 style="font-size:18px;margin:0">状況別ビュー</h1>
    <a class="btn" href="index.html">← Indexへ戻る</a>
    <span class="who" id="whoami"></span>
    <button id="signin" class="btn" style="margin-left:auto">Googleでログイン</button>
    <button id="signout" class="btn" style="display:none">ログアウト</button>
  </header>

  <main>
    <div class="controls">
      <label for="statusSelect">状態で絞り込み：</label>
      <select id="statusSelect" aria-label="状態を選択">
        <option value="">（状態を選択）</option>
        <option value="未着手">未着手</option>
        <option value="継続">継続</option>
        <option value="達成">達成</option>
      </select>
    </div>

    <div id="container" class="grid"></div>
  </main>

  <template id="cardTmpl">
    <section class="card">
      <h2></h2>
      <div class="list"></div>
    </section>
  </template>

  <template id="itemTmpl">
    <div class="item">
      <div class="title"></div>
      <button class="detail btn">詳細</button>
    </div>
  </template>

  <script type="module">
    const GENRES=["旅行・冒険","学習・スキル","キャリア・お金","健康・ライフスタイル","趣味・体験","精神・教養"];
    const STATUSES=["未着手","継続","達成"];
    const LS_KEY="bucketlist.v2";

    const whoami=document.getElementById("whoami");
    const signinBtn=document.getElementById("signin");
    const signoutBtn=document.getElementById("signout");

    const normalizeStatus = (s) => {
      const t = String(s||"").trim();
      if (STATUSES.includes(t)) return t;
      if (t.includes("達成")) return "達成";
      if (t.includes("継続")) return "継続";
      return "未着手";
    };

    function emptyState(){ return Object.fromEntries(GENRES.map(g=>[g,[]])); }
    function normalizeState(obj){
      const s=emptyState();
      for(const g of GENRES){
        const arr = Array.isArray(obj?.[g]) ? obj[g] : [];
        s[g]=arr.map(it=>({
          id:String(it.id||crypto.randomUUID()),
          title:String(it.title||""),
          status: normalizeStatus(it.status),
          deadline: String(it.deadline||""),
          note: String(it.note||"")
        }));
      }
      return s;
    }
    function loadLocal(){
      try{
        const raw=localStorage.getItem(LS_KEY);
        return raw ? normalizeState(JSON.parse(raw)) : emptyState();
      }catch(_){ return emptyState(); }
    }
    async function cloudLoadOrInit(uid){
      const { db, doc, getDoc, setDoc } = window.__fb;
      const ref = doc(db, "bucketlists", uid);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const st = normalizeState(snap.data()?.state || {});
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        return st;
      }else{
        const st = loadLocal();
        await setDoc(ref, { state: st, updatedAt: Date.now() });
        return st;
      }
    }

    let state = emptyState();
    const container=document.getElementById("container");
    const statusSelect=document.getElementById("statusSelect");
    const cardTmpl=document.getElementById("cardTmpl");
    const itemTmpl=document.getElementById("itemTmpl");

    function render(){
      container.innerHTML="";
      const selected=statusSelect.value;

      if(!selected){
        const msg=document.createElement("div");
        msg.className="muted";
        msg.textContent="状態を選択すると、その状態の項目だけを表示します。";
        container.appendChild(msg);
        return;
      }

      const sec=cardTmpl.content.firstElementChild.cloneNode(true);
      sec.querySelector("h2").textContent=selected;
      const list=sec.querySelector(".list");

      const items=[];
      for(const g of GENRES){
        (state[g]||[]).forEach(it=>{
          if (normalizeStatus(it.status) === selected){
            items.push({...it, genre:g});
          }
        });
      }

      if(items.length===0){
        const empty=document.createElement("div");
        empty.className="muted";
        empty.textContent="該当する項目がありません。";
        list.appendChild(empty);
      }else{
        items.forEach(it=>{
          const node=itemTmpl.content.firstElementChild.cloneNode(true);
          node.dataset.status=normalizeStatus(it.status);
          node.querySelector(".title").textContent=`[${it.genre}] ${it.title}`;
          node.querySelector(".detail").onclick=()=>{ location.href=`detail.html?id=${it.id}&from=status`; };
          list.appendChild(node);
        });
      }

      container.appendChild(sec);
    }

    // ===== 認証UI =====
    (function initAuth(){
      const { auth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = window.__fb;

      window.addEventListener('unhandledrejection', (e)=>{
        console.error('Unhandled:', e.reason);
        alert('[Auth Error]\n' + (e.reason?.code || e.reason?.message || e.reason));
      });

      signinBtn.onclick = async ()=>{
        const prov = new GoogleAuthProvider();
        try{ await signInWithPopup(auth, prov); }
        catch(err){ console.warn('popup NG → redirect', err?.code||err); await signInWithRedirect(auth, prov); }
      };
      signoutBtn.onclick = ()=> signOut(auth);
      getRedirectResult(auth).catch(err=>console.error('getRedirectResult:', err));

      onAuthStateChanged(auth, async (user)=>{
        if(user){
          signinBtn.style.display="none";
          signoutBtn.style.display="";
          whoami.textContent = `ログイン中：${user.displayName||user.email}`;
          state = await cloudLoadOrInit(user.uid);
        }else{
          signinBtn.style.display="";
          signoutBtn.style.display="none";
          whoami.textContent = "";
          state = loadLocal();
        }
        if(!statusSelect.value) statusSelect.value="継続"; // 初期選択
        render();
      });
    })();

    // フィルタ変更
    statusSelect.addEventListener("change", render);
  </script>
</body>
</html>
